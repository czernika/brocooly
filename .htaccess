# ------------------------------------------------------------------------------------------
#   Redirect request to web folder
# ------------------------------------------------------------------------------------------
RewriteEngine on

RewriteCond %{REQUEST_URI} !web/
RewriteRule (.*) /web/$1 [L]

# ------------------------------------------------------------------------------------------
#   ASSETS AND FILES
# ------------------------------------------------------------------------------------------
RewriteBase /

# Brotli
RewriteCond %{HTTP:Accept-encoding} br
RewriteCond %{REQUEST_URI} .*\.(css|js)
RewriteCond %{REQUEST_FILENAME}.br -s
RewriteRule ^(.+) $1.br
RewriteRule "\.css\.br$" "-" [T=text/css,E=no-brotli,E=no-gzip]
RewriteRule "\.js\.br$" "-" [T=application/javascript,E=no-brotli,E=no-gzip]

# Gzip
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{REQUEST_URI} .*\.(css|js)
RewriteCond %{REQUEST_FILENAME}.gz -s
RewriteRule ^(.+) $1.gz
RewriteRule "\.css\.gz$" "-" [T=text/css,E=no-brotli,E=no-gzip]
RewriteRule "\.js\.gz$" "-" [T=application/javascript,E=no-brotli,E=no-gzip]

<FilesMatch "\.(css|js)\.br$">
    # Prevent mime module to set brazilian language header (because the file ends with .br)
    RemoveLanguage .br
    Header set Content-Encoding br
    Header append Vary Accept-Encoding
</FilesMatch>

<FilesMatch "\.(css|js)\.gz$">
    Header set Content-Encoding gzip
    Header append Vary Accept-Encoding
</FilesMatch>

# Force text or pdf to be downloaded, not open in browser
AddType application/octet-stream .pdf .txt
# END Force Download

# ------------------------------------------------------------------------------------------
#   SECURITY
# ------------------------------------------------------------------------------------------

# Disable directory browsing
Options All -Indexes

# Limit request to 10Mb
LimitRequestBody 10240000

# Close author archive /?author=1 from being shown 
RewriteCond %{QUERY_STRING} author=d
RewriteRule ^ /? [L,R=301]

<Directory "web/wp">

   # Block wp-includes folder and files
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteBase /
        RewriteRule ^wp-admin/includes/ - [F,L]
        RewriteRule !^wp-includes/ - [S=3]
        RewriteRule ^wp-includes/[^/]+\.php$ - [F,L]
        RewriteRule ^wp-includes/js/tinymce/langs/.+\.php - [F,L]
        RewriteRule ^wp-includes/theme-compat/ - [F,L]
    </IfModule>

    # Prevent WordPress' readme.html from being accessed (as it contains the version number)
    <Files readme.html>
        Deny from all
    </Files>
</Directory>

# Protect wp-config.php file
<Files web/wp-config.php>
    order allow,deny
    deny from all
</Files>

# Protect .htaccess
<Files ~ "^.*\.([Hh][Tt][Aa])">
    order allow,deny
    deny from all
    satisfy all
</Files>
<Files .htaccess>
    order allow,deny
    deny from all
</Files>

# Block access to hidden files & directories
<IfModule mod_rewrite.c>
    RewriteCond %{SCRIPT_FILENAME} -d [OR]
    RewriteCond %{SCRIPT_FILENAME} -f
    RewriteRule "(^|/)\." - [F]
</IfModule>

# ------------------------------------------------------------------------------------------
#   Miscellaneous
# ------------------------------------------------------------------------------------------

# Allow Cross-Domain Fonts
<IfModule mod_headers.c>
    <FilesMatch "\.(eot|otf|ttc|ttf|woff|woff2)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# ------------------------------------------------------------------------------------------
#   CACHING
# ------------------------------------------------------------------------------------------

Header unset Pragma
FileETag None
Header unset ETag

<IfModule mod_deflate.c>
    <FilesMatch "\.(js|css|html|php)$">
        SetOutputFilter DEFLATE
    </FilesMatch>
</IfModule>

# Cache-Control Headers
<IfModule mod_headers.c>
    <FilesMatch "\\.(ico|jpe?g|png|gif|swf|gz)$">
        #1month
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
    <FilesMatch "\\.(css)$">
        #1week
        Header set Cache-Control "max-age=604800, public"
    </FilesMatch>
    <FilesMatch "\\.(js)$">
        #1month
        Header set Cache-Control "max-age=2592000, private"
    </FilesMatch>
    <FilesMatch "\\.(html|htm)$">
    	# 24h
    	Header set Cache-Control "max-age=86400, public"
    </FilesMatch>
</IfModule>

<FilesMatch "\.(ico|jpg|jpeg|png|gif|js|css|swf|pdf|flv|mp3|ttf)$">
    <IfModule mod_expires.c>
        ExpiresActive on
        ExpiresDefault "access plus 20 weeks"
        Header set Cache-Control "public"
    </IfModule>
</FilesMatch>

<FilesMatch "\.(html|htm|xml|txt|xsl)$">
    Header set Cache-Control "max-age=86400, must-revalidate"
</FilesMatch>